---
- hosts: CI_hosts
  tasks:
  - name: Log into Nexus
#    become: yes
#    become_user: ec2-user
#    remote_user: ec2-user
#    become_method: sudo
    docker_login:
#      docker_host: unix://run/containerd/containerd.sock
      registry: 172.31.40.122:8082
      username: upload
      password: GrurAv0Wrooc
  - name: Get a list of all running containers
    docker_host_info:
      containers: yes
    register: docker_info
  - name: Stop all running containers
    docker_container:
      name: '{{ item.Names[0] | regex_replace("^/", "") }}'
      state: stopped
    loop: '{{ docker_info.containers }}'
  - name: Create JAVA_APP container
#    become: yes
#    become_user: ec2-user
    docker_container:
      name: "grw_{{ build_Number }}"
      image: "{{ src_image }}"
      ports:
        - "{{ port_number }}:8080/tcp"
  - name: Log out of Nexus
#    become: yes
#    become_user: ec2-user
    docker_login:
      state: absent
